---
layout:     post
title:      ã€è¯¾å ‚ç¬”è®°ã€‘CSAPP Lecture 5 Machine-level Programming I:Basic
subtitle:   basic
date:       2020-11-4
author:     haoran
header-img: img/cover/snapshot.png
catalog: true
tags: 

    - CSAPP
    - æœºå™¨ç¼–ç 

typora-root-url: ..
---



## Lecture05 æœºå™¨çº§ç¼–ç¨‹(åŸºç¡€) è§‚çœ‹è®°å½•ğŸ“

01:49 è¯¾ç¨‹å­¦ä¹ æ–¹æ³•
03:54 intelå¤„ç†å™¨çš„å†å²å’Œæ¶æ„
06:25 RISCå’ŒCISCçš„å†å²
08:12 è‹±ç‰¹å°”æ¶æ„çš„é‡Œç¨‹ç¢‘
12:51 Corei7çš„æ¶æ„
14:28 ç«äº‰å¯¹æ‰‹AMDçš„å†å²
15:35 64ä½çš„è½¬å˜
17:49 ARMå¤„ç†å™¨
19:35 C,assembly,machine code
22:02 Machine/Assembly codeçš„è§†è§’
25:19 å°†Cä»£ç ç¿»è¯‘ä¸ºç›®æ ‡ä»£ç çš„è¿‡ç¨‹
30:12 Cä»£ç åˆ°æ±‡ç¼–ä»£ç çš„ä¾‹å­ï¼Œ-Oä¼˜åŒ–
34:36 æ±‡ç¼–ä»£ç çš„ç‰¹æ€§
34:48 æ•°æ®ç±»å‹
35:56 æ“ä½œ
36:54 sumstoreçš„ä¾‹å­
39:14 Disassemblingåæ±‡ç¼–å™¨ï¼šobjdumpå’Œgdb
47:50 AssemblyåŸºç¡€:å¯„å­˜å™¨ï¼Œæ“ä½œæ•°ï¼ŒmoveæŒ‡ä»¤
48:12 X86-64å¯„å­˜å™¨
53:38 moveæŒ‡ä»¤
56:59 Simple Memory Addressing Modes
58:09 ç®€å•å¯»å€çš„ä¾‹å­
56:59 Complex Memory Addressing Modes
65:12 å¯»å€çš„ä¾‹å­
66:15 ç®—æœ¯å’Œé€»è¾‘æ“ä½œ
66:40 leaæŒ‡ä»¤
73:02 æ€»ç»“

# Machine-Level Programming I: Basic

## Cç¼–è¯‘ä¸ºæœºå™¨ä»£ç 

### å®šä¹‰ï¼š

 

Assembly/Machine code View

![image-20201109170854512](/img/cloudNetworkingClass/2020-10-26-CSAPP%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%BA%94%E8%8A%82/image-20201109170854512.png)

 



## å°†Cä»£ç ç¼–è¯‘ä¸ºç¨‹åºçš„æ­¥éª¤ï¼š

![image-20201109170913515](/img/cloudNetworkingClass/2020-10-26-CSAPP%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%BA%94%E8%8A%82/image-20201109170913515.png)



## Compiling into Assembly

![image-20201109172335292](/img/cloudNetworkingClass/2020-10-26-CSAPP%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%BA%94%E8%8A%82/image-20201109172335292.png)

```shell
gcc -Og -S sum.c ##-O è¡¨ç¤ºç¼–è¯‘çš„ä¼˜åŒ–çº§åˆ«ï¼ˆ-Ogè¡¨ç¤ºåªæ˜¯ç¼–è¯‘ä¼˜åŒ–åˆ°ä¸€ä¸ªç‰¹å®šçš„æ±‡ç¼–æ–‡ä»¶ -Sè¡¨ç¤ºåªç¼–è¯‘åˆ°æ±‡ç¼–è¯­è¨€å°±æš‚åœç¼–è¯‘ï¼‰
```

## æ±‡ç¼–ä»£ç çš„ç‰¹æ€§

### Data Types

- Integer data 1, 2, 4 or 8 bytes
  - Data values
  - Address(untyped pointers)
- Floating point data of 4,8 or 10bytes é‡‡ç”¨çš„æ˜¯ä¸åŒçš„å¯„å­˜å™¨ç»„
- Codeï¼šå­—èŠ‚åºåˆ—
- å…¶ä»–çš„ä¸€äº›å˜é‡ç±»å‹ä¾‹å¦‚arraysæˆ–è€…ç»“æ„
  - åªæ˜¯äººå·¥åˆ†é…äº†ä¸€æ®µå†…å­˜ç©ºé—´å†…å­—èŠ‚è¿›è¡Œå­˜å‚¨

###  æ“ä½œ

- æ‰§è¡Œä¸€äº›ç®—æ•°çš„æ“ä½œæˆ–è€…æ˜¯é’ˆå¯¹å¯„å­˜å™¨å’Œå†…å­˜æ•°æ®çš„æ“ä½œ

- å°†å†…å­˜å’Œå¯„å­˜å™¨ä¹‹é—´æ•°æ®è¿›è¡Œè½¬æ¢ã€å¯„å­˜å™¨çš„å¯ä»¥æ‰§è¡Œçš„æ“ä½œå®é™…ä¸Šéå¸¸ç®€å•ã€‘

  - load data from memory into register
  - Store register data into memory

- Transfer control ã€å°†å¤æ‚çš„æ“ä½œè½¬æ¢ä¸ºç®€å•çš„æ“ä½œã€‘

  - Unconditional jumps to/from procedures
  - Control branchs

  

### æœºå™¨ç çš„ä¾‹å­

```cpp
//cpp å½¢å¼
*dest = t; //è¿™é‡Œtä¹Ÿæ˜¯æŒ‡é’ˆï¼Œç›¸å½“äºæ‹·è´tæŒ‡é’ˆçš„å†…å®¹
//æ±‡ç¼–å½¢å¼
movq %rax,(%rbx)
//æœºå™¨ç 
0x40059e: 48 89 03
```

- C code 

  - destæ‰€æŒ‡çš„åœ°å€ä¸ºå˜é‡tçš„å€¼

- Assembly

  - å°†8-byteçš„ä»£ç çš„å€¼èµ‹å€¼ç»™å†…å­˜

  - æ“ä½œç¬¦

    t:	Register %rax

    dest: Register %rbx

    *dest: Memory M[%rbx]

- Object Code

  - æœºå™¨æŒ‡ä»¤

- åæ±‡ç¼–å™¨

  objdump -d äºŒè¿›åˆ¶æ–‡ä»¶

  gdbä¸­çš„ disassemble å‡½æ•°å

## å¯„å­˜å™¨

![image-20201109225823058](/../../%E9%A1%B9%E7%9B%AE/2020-11-3%20CETC54%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81+%E6%96%87%E6%A1%A3/satellite_code/CETC-NFV/doc/image-20201109225823058.png)

- %rè¡¨ç¤º64è¿›åˆ¶çš„å¯„å­˜å™¨ï¼Œe%è¡¨ç¤º32ä½ï¼ˆå…¶ä¸­%eåœ¨64ä½æœºä¸­è¡¨ç¤ºçš„æ˜¯%rçš„ä½64ä½ï¼‰

### å¯„å­˜å™¨çš„æ“ä½œ

![image-20201110111635476](/img/cloudNetworkingClass/2020-10-26-CSAPP%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%BA%94%E8%8A%82/image-20201110111635476.png)

 ![image-20201110112014900](/img/cloudNetworkingClass/2020-10-26-CSAPP%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%BA%94%E8%8A%82/image-20201110112014900.png)

æ“ä½œå†…å®¹å†…å®¹è¡¨æ ¼å¯¹åº”ï¼š

![image-20201110112044696](/img/cloudNetworkingClass/2020-10-26-CSAPP%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%BA%94%E8%8A%82/image-20201110112044696.png)

**å¤‡æ³¨**ï¼š

- æ‹·è´çš„æ–¹å¼ä¸»è¦é€šè¿‡å†…å­˜->å¯„å­˜å™¨ï¼Œä»¥åŠå¯„å­˜å™¨->å†…å­˜ä¹‹é—´è¿›è¡Œ
- æ²¡æœ‰å†…å­˜å¯¹å†…å­˜çš„æ‹·è´ï¼ˆå®é™…ä¸Šï¼Œå†…å­˜æ‹·è´è¦æ±‚è¯»å–å†…å­˜çš„å†…å®¹åˆ°å¯„å­˜å™¨ï¼Œç„¶åå†å°†å¯„å­˜å™¨å†…å®¹å†™å…¥å¯¹åº”çš„å†…å­˜ï¼‰

## Simple Memory Addressing Models å¦‚ä½•ç¼–å†™æŒ‡é’ˆ

- **Normal  (R)  Mem[Reg[R]]** å¼•ç”¨

  - è¡¨ç¤ºé€‰å®šä¸€ä¸ªå¯„å­˜å™¨Ræ¥å­˜å‚¨æŸä¸ªå†…å­˜åœ°å€çš„å€¼ ï¼ˆRegister R specific memory addressï¼‰
  - ç›¸å½“äºè§£é™¤å¼•ç”¨æŒ‡é’ˆï¼Œå¹¶å°†å…¶ç½®äºä¸´æ—¶çŠ¶æ€(equivalent of dereference a pointer and putting it in a temporary)

  movq (%rcx),%rax

- **Displacement D(R) Mem[Reg[R]+D]**  ä½ç§»

  - å¯„å­˜å™¨RæŒ‡å‘æŸä¸ªå†…å­˜åœ°å€çš„å¼€å§‹
  - è·å¾—å…¶åç§»Dåçš„åœ°å€

  movq 8(%rbp),%rdx
  
- **Most General Forrm **ç”¨äºå®ç°ä¸€ä¸ªæ•°ç»„çš„ç´¢å¼•

  â€‹             **D(Rb,Ri,S)      Mem[Reg[Rb]+S*Reg[Ri]+D] å…¶ä¸­Då’ŒSå¯ä»¥ç¼ºçœï¼Œç¼ºçœæ˜¯D=0ï¼ŒS=1** 

  - D:  å¸¸æ•°è¡¨ç¤ºåç§»é‡1,2æˆ–è€…4 bytes
  - Rbï¼šbase registerï¼šä»»æ„çš„16æ•´æ•°å¯„å­˜å™¨
  - Riï¼šindex registerï¼šç´¢å¼•ä»»æ„ï¼Œé™¤äº†%rsp
  - Sï¼šScale factorï¼š1ï¼Œ2ï¼Œ4 or 8

### Example

#### 1ã€å†…å­˜å¼•ç”¨

```cpp
void swap(long *xp, long *yp){
    long t0 = *xp; 
    long t1 = *yp;
    *xp = t1;
    *yp = t0;
}
```

```assembly
swap:
	movq (%rdi),%rax #ç”¨(%rdi)ä¸ºåœ°å€ï¼Œä»è¯¥å†…å­˜çš„è¯¥åœ°å€å°†å¯¹åº”çš„å€¼å¤åˆ¶åˆ°å¯„å­˜å™¨%raxä¸­ã€‚
	movq (%rsi),%rdx 
	movq %rdx,(%rdi) #å°†%rdxå¯„å­˜å™¨å†…çš„å†…å®¹æ‹·è´åˆ°åœ°å€ä¸º(%rdi)å¤„çš„å†…å­˜ä¸­ã€‚
	movq %rax,(%rsi)
ret
```

| Rigster | Value |
| ------- | ----- |
| %rdi    | xp    |
| %rsi	| yp|
|%rax|t0|
|%rdx|t1|

##### å†…å­˜å¼•ç”¨çš„æ“ä½œè¿‡ç¨‹

![image-20201110175849385](/img/cloudNetworkingClass/2020-10-26-CSAPP%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%BA%94%E8%8A%82/image-20201110175849385.png)

![image-20201110175901519](/img/cloudNetworkingClass/2020-10-26-CSAPP%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%BA%94%E8%8A%82/image-20201110175901519.png)



#### 2ã€åœ°å€è®¡ç®—çš„ä¾‹å­

![image-20201110181312242](/img/cloudNetworkingClass/2020-10-26-CSAPP%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%BA%94%E8%8A%82/image-20201110181312242.png)





## è¿ç®—è¿‡ç¨‹

- **leaq Src,Dst**

  - Src is address mode expression
  - Set Dst to address denote by expression

- Uses

  - ä¸éœ€è¦å†…å­˜å¼•ç”¨æ¥è®¡ç®—åœ°å€ï¼ˆå’Œmovqä¸åŒï¼‰
    - E.g. translation of  p=&x[i]
  - è®¡ç®—ä¸€äº›ç®—æœ¯ï¼Œä¾‹å¦‚x+k*y
    - k=1,2,4 or 8

- Example

  ```cpp
  long m12(long x){
      return x*12;
  }
  ```

  ```ass
  leaq (%rdi,%rdi,2), %rax  #ç›¸å½“äº%rax=%rdi+2%rdi ç§»ä½åæ±‚å’Œ
  salq $2, %rax #ç›¸å½“äº%rax=4*%rax ç§»ä½å››ä½
  ```

  ![image-20201110215250609](/img/cloudNetworkingClass/2020-10-26-CSAPP%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%BA%94%E8%8A%82/image-20201110215250609.png)



  

![image-20201110215331928](/img/cloudNetworkingClass/2020-10-26-CSAPP%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%BA%94%E8%8A%82/image-20201110215331928.png)

## æ€»ç»“

![image-20201110215748847](/img/cloudNetworkingClass/2020-10-26-CSAPP%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%BA%94%E8%8A%82/image-20201110215748847.png)